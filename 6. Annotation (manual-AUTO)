# MANUAL

library(Seurat)
library(harmony)
library(DoubletFinder)
library(tibble)
library(celldex)
library(SingleR)
library(ggplot2)
library(tidyverse)
library(dplyr)
library(DESeq2)
library(limma)
library(presto)

load("data_markers.RData")
combined = merged_seurat
ref = celldex::HumanPrimaryCellAtlasData()
sc_counts = GetAssayData(combined,layers="data") 

pred = SingleR(test= sc_counts, ref= ref, label= ref$label.fine) 
combined$singleR.fine = pred$labels[match(rownames(combined@meta.data),rownames(pred))]

pred = SingleR(test= sc_counts, ref= ref, label= ref$label.main) 
combined$singleR.main = pred$labels[match(rownames(combined@meta.data),rownames(pred))]


kt = c("KRT1","KRT5", "KRT10", "KRT14") #keratinocytes 
fb = c("DCN", "COL1A1", "COL1A2") #fibroblasts
dmac = c("PTPRC", "CD68", "CD1C") #dendritic_macrophages
t_nk = c("PTPRC", "CD3D", "GNLY", "NKG7") 
endo = c("CD93", "ACKR1", "AQP1") #endothelial 
lym = c("CCL21", "LYVE1", "TFF3") #lymphatic
mel = c("TYRP1", "PMEL", "DCT") #melanocytes
sweat = c("DCD", "KRT19", "AQP5") #sweatglandcells
smooth = c("TAGLN", "ACTA2", "TPM2") #smooth_muscle

all_markers = c("KRT1","KRT5", "KRT10", "KRT14","DCN", "COL1A1", "COL1A2","PTPRC", "CD68", 
    "CD1C","CD3D", "GNLY","NKG7","CD93", "ACKR1", "AQP1","CCL21", "LYVE1", "TFF3",
    "TYRP1", "PMEL", "DCT","DCD", "KRT19", "AQP5", "TAGLN", "ACTA2", "TPM2")

new.cluster.ids = c("keratinocytes","keratinocytes","keratinocytes","keratinocytes",
"smoothmuscle","fibroblasts","endothelial","keratinocytes","keratinocytes","dmac",
"melanocytes","keratinocytes","lymphatic","T_cells","keratinocytes","keratinocytes","keratinocytes",
"sweet_glands_cells","endothelial","fibroblasts","keratinocytes")
annotated = combined
names(new.cluster.ids) <- levels(annotated)
annotated <- RenameIdents(annotated, new.cluster.ids)

annotated$celltype = Idents(annotated)

save(annotated,combined,markers,file="start_pseudobulk.RData")

#############################################################
###########################################################

###############################################################################
# 9. AUTOMATIC (SingleR annotation)
###############################################################################
ref <- celldex::HumanPrimaryCellAtlasData()

# Seurat v5: unisci tutti i counts layers in una matrice unica
# da checkare -> io usavo JoinLayers ma non c'era ancora Seurat v5

count_layers <- grep("^counts", Layers(merged_seurat[["RNA"]]), value = TRUE)
sc_counts_list <- lapply(count_layers, function(lay) merged_seurat[["RNA"]]@layers[[lay]])
sc_counts <- do.call(cbind, sc_counts_list)

stopifnot(!is.null(rownames(sc_counts)), !is.null(colnames(sc_counts)))

# Annotazione fine e main
pred_fine <- SingleR(test = sc_counts, ref = ref, labels = ref$label.fine)
merged_seurat$singleR.fine <- pred_fine$labels[match(colnames(merged_seurat), rownames(pred_fine))]

pred_main <- SingleR(test = sc_counts, ref = ref, labels = ref$label.main)
merged_seurat$singleR.main <- pred_main$labels[match(colnames(merged_seurat), rownames(pred_main))]

###############################################################################
# 10. Salvataggio finale
###############################################################################
saveRDS(merged_seurat, file.path(filtered_dir, "merged_seurat_postHarmony_annotated.rds"))
message("âœ… Analisi completa e oggetto salvato")
