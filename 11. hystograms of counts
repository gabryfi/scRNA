####   Barplot conte cellule per tipo e condizione
#### ==========================================

library(ggplot2)
library(dplyr)

# --- Calcola le conte per tipo cellulare e condizione ---
cell_counts <- annotated@meta.data %>%
  group_by(celltype, Condition) %>%
  summarise(Count = n(), .groups = "drop") %>%
  # Estrai solo il nome principale (prima dei ":") per uniformit√†
  mutate(celltype_main = sapply(strsplit(as.character(celltype), ":"), `[`, 1))

# --- Calcola posizione centrale per le etichette sull'asse X ---
label_positions <- cell_counts %>%
  group_by(celltype_main) %>%
  summarise(x_pos = mean(as.numeric(factor(celltype_main))), .groups = "drop")

# --- Barplot affiancato ---
p_counts <- ggplot(cell_counts, aes(x = factor(celltype_main), y = Count, fill = Condition)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_fill_manual(values = c("BP" = "red", "HC" = "blue")) +
  labs(
    y = "Numero di cellule",
    x = "Tipo cellulare",
    fill = "Condizione",
    title = "Conte delle cellule per tipo cellulare e condizione"
  ) +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.title.x = element_text(face = "bold"),
    plot.title = element_text(hjust = 0.5)
  )

# --- Mostra il plot ---
print(p_counts)

# --- Salva il plot in PNG ---
ggsave("cell_counts_barplot_affiancato.png", p_counts, width = 12, height = 6, dpi = 300)

