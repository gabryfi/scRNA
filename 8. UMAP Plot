####   UMAPs per Condition e per Cell Type
#### ==========================================

library(Seurat)
library(ggplot2)
library(dplyr)
library(RColorBrewer)

# --- 1️⃣ UMAP per Condition (HC vs BP) ---
p_condition <- DimPlot(
  annotated,
  reduction = "umap",
  group.by = "Condition",
  pt.size = 0.5
) +
  ggtitle("UMAP - Condition (HC vs BP)") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )

ggsave(
  filename = "UMAP_condition_HC_BP.png",
  plot = p_condition,
  width = 10, height = 8, dpi = 300
)

# --- 2️⃣ UMAP per Cell Types (solo nomi, top 20 + Other) ---

annotated$CellType_main <- sapply(strsplit(as.character(annotated$celltype), ":"), `[`, 1)
cell_counts <- table(annotated$CellType_main)
top20 <- names(sort(cell_counts, decreasing = TRUE)[1:20])

annotated$CellType_plot <- ifelse(
  annotated$CellType_main %in% top20,
  annotated$CellType_main,
  "Other"
)
annotated$CellType_plot <- factor(annotated$CellType_plot, levels = c(top20, "Other"))

palette_colors <- c(brewer.pal(12, "Set3"), brewer.pal(8, "Paired"), "grey80")

p_celltype <- DimPlot(
  annotated,
  reduction = "umap",
  group.by = "CellType_plot",
  label = TRUE,
  repel = TRUE,
  label.size = 5,
  cols = palette_colors[1:length(levels(annotated$CellType_plot))]
) +
  ggtitle("UMAP - Top 20 Cell Types") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5),
    legend.position = "right"
  )

ggsave(
  filename = "UMAP_top20_celltypes.png",
  plot = p_celltype,
  width = 20, height = 15, dpi = 300
)

